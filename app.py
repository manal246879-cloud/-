import streamlit as st
import google.generativeai as genai
from pypdf import PdfReader
from gtts import gTTS
import os
import tempfile # Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ±Ø§ÙƒÙ… Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬Ø§Ù…Ø¹Ø© Ù†ÙˆØ±Ø© ---
st.set_page_config(page_title="ÙØ²Ø¹Ø©ØŒ ØªØ³ÙˆÙ„ÙÙ‡Ø§", page_icon="ğŸŒ¸", layout="centered")

# --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù€ API Key Ø¨Ø£Ù…Ø§Ù† ---
try:
    # Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Secrets
    api_key = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=api_key)
except Exception:
    st.warning("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© GEMINI_API_KEY ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Secrets Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØ²Ø¹Ø©.")
    st.stop()

st.title("ğŸŒ¸ ÙØ²Ø¹Ø©ØŒ ØªØ³ÙˆÙ„ÙÙ‡Ø§")
st.subheader("Ù…Ù† ØªØ¹Ù‚ÙŠØ¯ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠâ€¦ Ø¥Ù„Ù‰ Ø¬Ù„Ø³Ø© Ø³ÙˆØ§Ù„Ù")

uploaded_file = st.file_uploader("Ø§Ø±ÙØ¹ÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (PDF)", type="pdf")

if uploaded_file:
    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ
    try:
        reader = PdfReader(uploaded_file)
        # Ø£Ø®Ø° Ø£ÙˆÙ„ 15 ØµÙØ­Ø© ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        pages_to_read = reader.pages[:15] 
        text_list = []
        for page in pages_to_read:
            content = page.extract_text()
            if content:
                text_list.append(content)
        
        full_text = " ".join(text_list)
        
        if len(full_text) < 10:
            st.error("ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ØµÙˆØ± ÙÙ‚Ø· (Ø³ÙƒØ§Ù†). Ø¬Ø±Ø¨ÙŠ Ù…Ù„Ù Ù†ØµÙŠ.")
            st.stop()
            
    except Exception as e:
        st.error(f"Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: {e}")
        st.stop()

    st.success("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø®ØªØ§Ø±ÙŠ Ù†ÙˆØ¹ Ø§Ù„ÙØ²Ø¹Ø©:")
    col1, col2, col3 = st.columns(3)
    prompt = ""
    
    # ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ù†ØªØ§Ø¦Ø¬ Ø£ÙØ¶Ù„
    context = "\n\n Ø§Ù„Ù†Øµ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ: \n" + full_text[:10000] # Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø³Ù„

    if col1.button("ğŸ‡¸ğŸ‡¦ Ø³ÙˆÙ„ÙÙ‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ"):
        prompt = "Ø§Ø´Ø±Ø­ÙŠ Ù„ÙŠ Ù‡Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù„Ù‡Ø¬Ø© Ù†Ø¬Ø¯ÙŠØ© Ø¹ÙÙˆÙŠØ© ÙƒØ£Ù†Ùƒ ØªØ³ÙˆÙ„ÙÙŠÙ† Ù…Ø¹ÙŠØŒ Ø±ÙƒØ²ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙˆØ¨Ø³Ø·ÙŠ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„ØµØ¹Ø¨Ø©:" + context
    if col2.button("ğŸ‡ºğŸ‡¸â¡ï¸ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨Ù†Ø§Ù‡Ø§ Ù„Ùƒ"):
        prompt = "ØªØ±Ø¬Ù…ÙŠ Ù‡Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙˆØ§Ø´Ø±Ø­ÙŠÙ‡ Ø¨Ù„Ù‡Ø¬Ø© Ù†Ø¬Ø¯ÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ØŒ ÙˆÙÙ‡Ù…ÙŠÙ†ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­:" + context
    if col3.button("ğŸ‡¬ğŸ‡§ English"):
        prompt = "Explain this academic content in very simple, conversational English as if you are talking to a friend:" + context

    if prompt:
        with st.spinner("Ù‚Ø§Ø¹Ø¯ÙŠÙ† Ù†ÙØ²Ø¹ Ù„Ùƒ... âœ¨"):
            try:
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø« ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø±
                model = genai.GenerativeModel('gemini-1.5-flash-latest')
                response = model.generate_content(prompt)
                
                if response.text:
                    st.markdown("---")
                    st.markdown("### ğŸ“– Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…ÙˆÙ„Ø¯")
                    st.write(response.text)

                    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù Ù…Ø¤Ù‚Øª ÙØ±ÙŠØ¯
                    with st.spinner("Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙˆØ§Ù„Ù ØµÙˆØªÙŠØ§Ù‹... ğŸ¤"):
                        tts_lang = 'en' if "English" in prompt else 'ar'
                        tts = gTTS(text=response.text[:1000], lang=tts_lang) # Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙˆØª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                        
                        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¤Ù‚Øª
                        with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as fp:
                            tts.save(fp.name)
                            st.audio(fp.name)
                            # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø³ÙŠØ±ÙØ±
                            os.unlink(fp.name) 
                else:
                    st.error("Ø§Ù„Ù€ API Ù…Ø§ Ø¹Ø·Ø§Ù†Ø§ Ø±Ø¯ØŒ Ø¬Ø±Ø¨ÙŠ ØªØ¶ØºØ·ÙŠÙ† Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.")

            except Exception as e:
                if "404" in str(e):
                    st.error("Ø®Ø·Ø£ 404: Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø¬Ø±Ø¨ÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.")
                else:
                    st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")

---

### Ø¥Ø¶Ø§ÙØ§Øª Ù…Ù‡Ù…Ø© Ø³ÙˆÙŠØªÙ‡Ø§ Ù„Ùƒ:
1.  **Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** Ø¬Ø¹Ù„Øª Ø§Ù„ÙƒÙˆØ¯ ÙŠÙ‚Ø±Ø£ Ø£ÙˆÙ„ **15 ØµÙØ­Ø©** ÙÙ‚Ø·ØŒ Ù„Ø£Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£ÙƒØ¨Ø± Ù‚Ø¯ ØªØ³Ø¨Ø¨ Ø¨Ø·Ø¡ Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù€ API.
2.  **ØªÙ†Ø¨ÙŠÙ‡ "Ø§Ù„ØµÙˆØ±":** Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ PDF Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ØµÙˆØ± (Ø¨Ø¯ÙˆÙ† Ù†Øµ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ø³Ø®)ØŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠØ¹Ø·ÙŠÙƒ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ·Ù„Ø¹ Ø®Ø·Ø£ Ù…Ø¨Ù‡Ù….
3.  **Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© (`tempfile`):** Ø§Ù„Ø¢Ù† Ù„Ùˆ Ø¯Ø®Ù„ 10 Ø·Ø§Ù„Ø¨Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚ØªØŒ ÙƒÙ„ ÙˆØ­Ø¯Ø© Ø¨ÙŠØ·Ù„Ø¹ Ù„Ù‡Ø§ Ù…Ù„Ù ØµÙˆØªÙŠ Ø®Ø§Øµ ÙÙŠÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØ¯Ø§Ø®Ù„.
4.  **ØªØ·ÙˆÙŠØ± Ø§Ù„Ù€ Prompt:** Ø®Ù„ÙŠØª Ø§Ù„Ù€ AI ÙŠÙÙ‡Ù… Ø¥Ù†Ù‡ Ù„Ø§Ø²Ù… ÙŠØ´Ø±Ø­ "Ø¨Ø¨Ø³Ø§Ø·Ø©" Ùˆ "ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ÙØ§Ø¦Ø¯Ø©" Ø¹Ø´Ø§Ù† ØªØ·Ù„Ø¹ Ø§Ù„Ø³ÙˆØ§Ù„Ù Ù…Ø¶Ø¨ÙˆØ·Ø©.

**Ù„Ø§ ØªÙ†Ø³ÙŠÙ†** ØªØ­Ø°ÙÙŠÙ† Ø§Ù„Ù€ API Key Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ù…ÙˆÙ‚Ø¹ Google ÙˆØªØ·Ù„Ø¹ÙŠÙ† ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯ ÙˆØªØ­Ø·ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ø³ÙŠÙƒØ±ØªØ³ØŒ Ù„Ø£Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… ØµØ§Ø± "Ø¹Ø§Ù…" Ø§Ù„Ø¢Ù†.

Ù‡Ù„ ØªØ¨ÙŠÙ† Ù†Ø¹Ø¯Ù„ ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© "Ø§Ù„Ø³ÙˆØ§Ù„Ù" ÙˆÙ†Ø®Ù„ÙŠÙ‡Ø§ Ø¨Ù„Ù‡Ø¬Ø© Ù…Ø­Ø¯Ø¯Ø© Ø£ÙƒØ«Ø± (Ù…Ø«Ù„ Ù„Ù‡Ø¬Ø© Ø£Ù‡Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹)ØŸ
